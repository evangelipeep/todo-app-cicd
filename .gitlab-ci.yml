stages:
  - build
  - test
  - deploy_dev
  - deploy_prod
  - finish

variables:
  CICD_VERSION: "v1.0"
  LOG_FILE_NAME: "$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA.txt"
  CI: "true"

image: node:20

default:
  artifacts:
    paths:
      - $LOG_FILE_NAME
    when: always
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

build_job:
  stage: build
  script:
    - echo "--- Build Started ---"
    - npm install --legacy-peer-deps
    - npm run build
    - echo "âœ… Build completed on branch $CI_COMMIT_BRANCH" >> $LOG_FILE_NAME

unit_tests_job:
  stage: test
  needs: [build_job]
  script:
    - echo "--- Unit Tests Started ---"
    - npm test -- --watchAll=false
    - echo "âœ… Unit tests passed" >> $LOG_FILE_NAME

e2e_tests_job:
  stage: test
  image: cypress/browsers:node-20.5.0-chrome-114-ff114
  needs: [build_job]
  script:
    - echo "--- E2E Tests Started ---"
    - npm install --legacy-peer-deps
    - npm start &
    - npx wait-on http://localhost:3000
    - npx cypress run --config-file cypress.config.js
    - echo "âœ… E2E tests passed" >> $LOG_FILE_NAME

deploy_to_dev_job:
  stage: deploy_dev
  needs: [unit_tests_job, e2e_tests_job]
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  script:
    - echo "--- Deploy to DEV Started ---"
    - echo "ðŸš€ Deploying to DEV environment..."
    - echo "âœ… Deploy to DEV completed" >> $LOG_FILE_NAME

deploy_to_prod_job:
  stage: deploy_prod
  needs: [unit_tests_job, e2e_tests_job]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - echo "--- Deploy to PROD Started ---"
    - echo "ðŸš€ Deploying to PRODUCTION environment..."
    - echo "âœ… Deploy to PROD completed" >> $LOG_FILE_NAME

finish_job:
  stage: finish
  needs: [deploy_to_dev_job, deploy_to_prod_job]
  script:
    - echo "--- Finish Job Started ---"
    - echo "ðŸ“¦ Pipeline $CICD_VERSION finished by branch $CI_COMMIT_BRANCH" >> $LOG_FILE_NAME
    - cat $LOG_FILE_NAME
