stages:
  - build
  - test
  - deploy_dev
  - deploy_prod
  - finish

variables:
  CICD_VERSION: "v1.0"
  LOG_FILE_NAME: "$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA.txt"

image: node:20

#  ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð´Ð»Ñ Ð²ÑÐµÑ… job
default:
  artifacts:
    paths:
      - $LOG_FILE_NAME
    when: always
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

#  Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
build_job:
  stage: build
  script:
    - echo "--- Build Started ---"
    - npm install
    - npm run build
    - echo "âœ… Build completed on branch $CI_COMMIT_BRANCH" >> $LOG_FILE_NAME

#  Unit-Ñ‚ÐµÑÑ‚Ñ‹ (Jest)
unit_tests_job:
  stage: test
  script:
    - echo "--- Unit Tests Started ---"
    - npm test -- --watchAll=false
    - echo "âœ… Unit tests passed" >> $LOG_FILE_NAME

#  E2E-Ñ‚ÐµÑÑ‚Ñ‹ (Cypress)
e2e_tests_job:
  stage: test
  image: cypress/browsers:node20.10.0-chrome114-ff115
  needs: [build_job]
  script:
    - echo "--- E2E Tests Started ---"
    - npm ci
    - npm start &
    - npx wait-on http://localhost:3000
    - npx cypress run
    - echo "âœ… E2E tests passed" >> $LOG_FILE_NAME

#  Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° dev
deploy_to_dev_job:
  stage: deploy_dev
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  script:
    - echo "--- Deploy to DEV Started ---"
    - echo "ðŸš€ Deploying to DEV environment..."
    - echo "âœ… Deploy to DEV completed" >> $LOG_FILE_NAME

#  Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° main (Ð¿Ñ€Ð¾Ð´)
deploy_to_prod_job:
  stage: deploy_prod
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - echo "--- Deploy to PROD Started ---"
    - echo "ðŸš€ Deploying to PRODUCTION environment..."
    - echo "âœ… Deploy to PROD completed" >> $LOG_FILE_NAME

#  Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¾Ð³
finish_job:
  stage: finish
  script:
    - echo "--- Finish Job Started ---"
    - echo "ðŸ“¦ Pipeline $CICD_VERSION finished by branch $CI_COMMIT_BRANCH" >> $LOG_FILE_NAME
    - cat $LOG_FILE_NAME
